# Django initialization - runs once after deployment
# Runs migrations, registers instance, and configures settings

container_commands:
  01_run_migrations:
    command: |
      #!/bin/bash
      set -e

      # Source custom environment (secrets from Secrets Manager)
      if [ -f /opt/elasticbeanstalk/deployment/custom_env ]; then
        source /opt/elasticbeanstalk/deployment/custom_env
      fi

      cd /var/app/staging
      source /var/app/venv/staging-*/bin/activate

      echo "=========================================="
      echo "RUNNING DJANGO MIGRATIONS (with advisory lock)"
      echo "=========================================="

      # Run migrations with PostgreSQL advisory lock for safety
      # Defense in depth: leader_only prevents most races, advisory lock catches edge cases
      # --skip-if-locked: if another instance somehow got here first, skip and verify
      python manage.py migrate_with_lock --skip-if-locked

      echo "Migrations complete"
    leader_only: true

  02_register_instance:
    command: |
      #!/bin/bash
      set -e

      # Source custom environment
      if [ -f /opt/elasticbeanstalk/deployment/custom_env ]; then
        source /opt/elasticbeanstalk/deployment/custom_env
      fi

      cd /var/app/staging
      source /var/app/venv/staging-*/bin/activate

      echo "=========================================="
      echo "REGISTERING INSTANCE"
      echo "=========================================="

      # Generate a machine signature from the instance metadata (IMDSv2)
      # IMDSv2 requires getting a token first, then using it to fetch metadata
      TOKEN=$(curl -s -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 60" 2>/dev/null || echo "")
      if [ -n "$TOKEN" ]; then
        MACHINE_SIG=$(curl -s -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/instance-id 2>/dev/null || echo "")
      fi

      # Fallback to hostname if IMDS failed
      if [ -z "$MACHINE_SIG" ]; then
        MACHINE_SIG="plane-instance-$(hostname)"
      fi

      echo "Using machine signature: $MACHINE_SIG"
      python manage.py register_instance "$MACHINE_SIG"

      echo "Instance registration complete"
    leader_only: true

  03_configure_instance:
    command: |
      #!/bin/bash
      set -e

      # Source custom environment
      if [ -f /opt/elasticbeanstalk/deployment/custom_env ]; then
        source /opt/elasticbeanstalk/deployment/custom_env
      fi

      cd /var/app/staging
      source /var/app/venv/staging-*/bin/activate

      echo "=========================================="
      echo "CONFIGURING INSTANCE"
      echo "=========================================="

      python manage.py configure_instance

      echo "Instance configuration complete"
    leader_only: true

  04_collect_static:
    command: |
      #!/bin/bash
      set -e

      # Source custom environment
      if [ -f /opt/elasticbeanstalk/deployment/custom_env ]; then
        source /opt/elasticbeanstalk/deployment/custom_env
      fi

      cd /var/app/staging
      source /var/app/venv/staging-*/bin/activate

      echo "=========================================="
      echo "COLLECTING STATIC FILES"
      echo "=========================================="

      python manage.py collectstatic --noinput

      echo "Static files collected"
    leader_only: false
