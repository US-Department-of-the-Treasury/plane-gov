# Pre-deployment validation and secrets fetch from SSM Parameter Store
# Uses container_commands which run after app staging but before Procfile start
#
# Environment variables required:
#   PROJECT     - Project name (e.g., "plane")
#   ENVIRONMENT - Environment name (e.g., "dev", "prod")
#   AWS_REGION  - AWS region (defaults to us-east-1)
#
# SSM parameters are fetched from: /${PROJECT}/${ENVIRONMENT}/*

commands:
  01_create_deployment_dir:
    command: mkdir -p /opt/elasticbeanstalk/deployment && chmod 755 /opt/elasticbeanstalk/deployment

container_commands:
  00_fetch_secrets:
    command: |
      #!/bin/bash
      # NOTE: Do NOT use set -e - it causes issues with command substitution in ebextensions
      # Use explicit error checking instead

      echo "=========================================="
      echo "FETCHING SECRETS FROM SSM PARAMETER STORE"
      echo "$(date): Starting secrets fetch..."
      echo "=========================================="

      # Source EB environment if available
      if [ -f /opt/elasticbeanstalk/deployment/env ]; then
        . /opt/elasticbeanstalk/deployment/env
      fi

      # Configuration
      PROJECT="${PROJECT:-plane}"
      ENV="${ENVIRONMENT:-dev}"
      AWS_REGION="${AWS_REGION:-us-east-1}"
      SSM_PATH="/${PROJECT}/${ENV}"
      ENV_FILE="/opt/elasticbeanstalk/deployment/custom_env"

      echo "Project: $PROJECT"
      echo "Environment: $ENV"
      echo "SSM Path: $SSM_PATH"
      echo "Region: $AWS_REGION"
      echo ""

      # Clear previous custom env file
      > $ENV_FILE || { echo "ERROR: Cannot create $ENV_FILE"; exit 1; }
      chmod 644 $ENV_FILE

      # Helper to safely write env var (escapes special chars using single quotes)
      write_env() {
        local name="$1"
        local value="$2"
        # Use single quotes and escape any embedded single quotes
        local escaped_value="${value//\'/\'\\\'\'}"
        echo "export ${name}='${escaped_value}'" >> $ENV_FILE
      }

      # Fetch all parameters from SSM path
      echo "Fetching parameters from ${SSM_PATH}..."
      echo "Running: aws ssm get-parameters-by-path --path $SSM_PATH --with-decryption --region $AWS_REGION"

      PARAMS=$(aws ssm get-parameters-by-path \
        --path "$SSM_PATH" \
        --with-decryption \
        --query "Parameters[*].[Name,Value]" \
        --output text \
        --region "$AWS_REGION" 2>&1)
      SSM_EXIT_CODE=$?

      echo "SSM command exit code: $SSM_EXIT_CODE"

      if [ $SSM_EXIT_CODE -ne 0 ]; then
        echo "ERROR: Failed to fetch SSM parameters (exit code: $SSM_EXIT_CODE)"
        echo "Output: $PARAMS"
        exit 1
      fi

      if [ -z "$PARAMS" ]; then
        echo "ERROR: No parameters found in ${SSM_PATH}"
        echo "Run terraform apply to create SSM parameters."
        exit 1
      fi

      # Process each parameter
      PARAM_COUNT=0
      while IFS=$'\t' read -r name value; do
        if [ -n "$name" ] && [ -n "$value" ]; then
          # Convert SSM name to env var name
          # /plane/dev/database-url -> DATABASE_URL
          # /plane/dev/api-base-url -> API_BASE_URL
          param_suffix="${name##${SSM_PATH}/}"  # Remove path prefix
          env_var=$(echo "$param_suffix" | tr '[:lower:]-' '[:upper:]_')

          # Write to env file
          write_env "$env_var" "$value"
          ((PARAM_COUNT++))

          # Log (mask sensitive values)
          if [[ "$param_suffix" == *"secret"* ]] || [[ "$param_suffix" == *"password"* ]] || [[ "$param_suffix" == "database-url" ]]; then
            echo "  OK: $env_var = ****"
          else
            # Truncate long values
            if [ ${#value} -gt 50 ]; then
              echo "  OK: $env_var = ${value:0:47}..."
            else
              echo "  OK: $env_var = $value"
            fi
          fi
        fi
      done <<< "$PARAMS"

      echo ""
      echo "Fetched $PARAM_COUNT parameters from SSM"

      # Validation: Check required parameters
      REQUIRED_VARS=("DATABASE_URL" "SECRET_KEY")
      MISSING=0

      for var in "${REQUIRED_VARS[@]}"; do
        if ! grep -q "^export ${var}=" "$ENV_FILE"; then
          echo "ERROR: Required parameter missing: $var"
          ((MISSING++))
        fi
      done

      if [ $MISSING -gt 0 ]; then
        echo ""
        echo "ERROR: Missing $MISSING required parameters"
        echo "Check SSM parameters in ${SSM_PATH}"
        exit 1
      fi

      # Handle REDIS_URL from EB environment (set directly in Terraform)
      if [ -n "$REDIS_URL" ]; then
        write_env REDIS_URL "$REDIS_URL"
        echo "  OK: REDIS_URL = (from EB env)"
        ((PARAM_COUNT++))
      fi

      echo ""
      echo "CUSTOM_ENV FILE CREATED:"
      cat $ENV_FILE | sed 's/\(PASSWORD\|SECRET_KEY\|DATABASE_URL\)='\''[^'\'']*'\''/\1='\''***REDACTED***'\''/g'
      echo ""
      echo "=========================================="
      echo "SECRETS FETCH COMPLETE ($PARAM_COUNT parameters)"
      echo "=========================================="
    leader_only: false
