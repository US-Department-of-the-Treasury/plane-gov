name: Security Audit - External Data Exfiltration

on:
  pull_request:
    branches: [main, master, preview]
  push:
    branches: [main, master, preview]

jobs:
  audit-external-calls:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Check for analytics SDKs
        run: |
          echo "Checking for analytics/telemetry SDKs..."
          if grep -rI "posthog\|sentry\|clarity\|mixpanel\|amplitude" \
            --include="*.ts" --include="*.tsx" --include="*.js" --include="*.py" \
            --exclude-dir=node_modules --exclude-dir=venv --exclude-dir=build --exclude-dir=dist \
            .; then
            echo "❌ FAIL: Analytics SDK found"
            exit 1
          fi
          echo "✅ PASS: No analytics SDKs"

      - name: Check for external URLs in production code
        run: |
          echo "Checking for hardcoded external URLs..."
          # Allow OAuth providers, AWS, Azure Gov
          ALLOWED="github\.com|googleapis\.com|login\.gov|usgovcloudapi\.net"

          if grep -rI "https://[a-zA-Z0-9.-]*\.\(com\|io\|net\|org\)" \
            --include="*.ts" --include="*.tsx" --include="*.js" --include="*.py" \
            --exclude-dir=node_modules --exclude-dir=venv --exclude-dir=build --exclude-dir=dist --exclude-dir=test --exclude-dir=tests \
            . | \
            grep -v "$ALLOWED" | \
            grep -v "example\.com\|localhost\|127\.0\.0\.1"; then
            echo "❌ FAIL: Unexpected external URL found"
            exit 1
          fi
          echo "✅ PASS: No unexpected external URLs"

      - name: Check for tracking environment variables
        run: |
          echo "Checking for tracking service environment variables..."
          if grep "SENTRY_DSN\|POSTHOG_KEY\|CLARITY_PROJECT\|INTERCOM_APP_ID\|MIXPANEL_TOKEN" \
            .env.example; then
            echo "❌ FAIL: Tracking service environment variable found"
            exit 1
          fi
          echo "✅ PASS: No tracking environment variables"

      - name: Check email templates for external resources
        run: |
          echo "Checking email templates for external resources..."
          if find apps/api/templates -name "*.html" -exec grep -l "src=\"http\|href=\"http" {} \;; then
            echo "❌ FAIL: External resource in email template"
            exit 1
          fi
          echo "✅ PASS: No external resources in email templates"

      - name: Check for window.* tracking calls
        run: |
          echo "Checking for browser tracking calls..."
          if grep -rI "window\.\(gtag\|ga\|dataLayer\|clarity\|Intercom\|Sentry\)" \
            --include="*.ts" --include="*.tsx" --include="*.js" \
            --exclude-dir=node_modules --exclude-dir=build --exclude-dir=dist \
            .; then
            echo "❌ FAIL: Browser tracking call found"
            exit 1
          fi
          echo "✅ PASS: No browser tracking calls"

  dependency-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Check for analytics packages
        run: |
          echo "Checking package.json for analytics dependencies..."
          BLOCKED_PKGS="@sentry/|posthog|@posthog/|clarity|@intercom/|mixpanel|amplitude"

          if grep -E "$BLOCKED_PKGS" package.json apps/*/package.json 2>/dev/null; then
            echo "❌ FAIL: Analytics package found in dependencies"
            exit 1
          fi
          echo "✅ PASS: No analytics packages"

      - name: Check Python requirements for analytics
        run: |
          echo "Checking requirements.txt for analytics dependencies..."
          if grep -iE "sentry|posthog|mixpanel|amplitude" \
            apps/api/requirements*.txt 2>/dev/null; then
            echo "❌ FAIL: Analytics package found in Python requirements"
            exit 1
          fi
          echo "✅ PASS: No analytics packages in Python requirements"
