name: Security Scan

on:
  push:
    branches: [master, main, preview]
  pull_request:
    branches: [master, main, preview]

permissions:
  contents: read
  security-events: write

jobs:
  gitleaks:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  terraform-security:
    name: Terraform Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: terraform
          soft_fail: true  # Don't fail the build, just report

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: terraform
          framework: terraform
          soft_fail: true
          output_format: cli
          skip_check: CKV_AWS_144,CKV_AWS_145  # Cross-region replication not required for dev

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          deny-licenses: GPL-3.0, AGPL-3.0

  open-source-compliance:
    name: Open Source Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for sensitive patterns
        run: |
          echo "Checking for sensitive patterns that should not be in open source..."

          # Check for AWS Account IDs (12-digit numbers in specific contexts)
          if grep -rE 'account[_-]?id.*[0-9]{12}' --include="*.tf" --include="*.json" --include="*.yaml" --include="*.yml" . 2>/dev/null | grep -v '.example' | grep -v 'node_modules'; then
            echo "::warning::Found potential AWS account IDs in code"
          fi

          # Check for hardcoded internal domains
          if grep -rE '\.treas\.gov|\.treasury\.gov' --include="*.tf" --include="*.tfvars" . 2>/dev/null | grep -v '.example' | grep -v 'node_modules'; then
            echo "::warning::Found Treasury internal domains - ensure these are in example files only"
          fi

          # Check for Route53 Zone IDs
          if grep -rE 'Z[A-Z0-9]{10,}' terraform/*.tf 2>/dev/null | grep -v '.example'; then
            echo "::warning::Found potential Route53 Zone IDs in Terraform files"
          fi

          # Check for terraform.tfvars (should be gitignored)
          if [ -f "terraform/terraform.tfvars" ]; then
            echo "::error::terraform/terraform.tfvars should not be committed - it's in .gitignore"
            exit 1
          fi

          # Check for state files
          if ls terraform/*.tfstate 2>/dev/null; then
            echo "::error::Terraform state files should not be committed"
            exit 1
          fi

          echo "Open source compliance checks passed"

      - name: Verify required open source files
        run: |
          echo "Checking for required open source files..."

          required_files=(
            "LICENSE.txt"
            "README.md"
            "SECURITY.md"
            "CONTRIBUTING.md"
            "code.json"
          )

          missing_files=()
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
            fi
          done

          if [ ${#missing_files[@]} -gt 0 ]; then
            echo "::error::Missing required open source files: ${missing_files[*]}"
            exit 1
          fi

          echo "All required open source files present"
