# Claude Work Handoff

## Original Plan

See `/Users/corcoss/code/plane/plans/shadow-user-invitation-pattern.md` for the full plan.

**Summary:** Convert invitation system from two-table pattern (User + WorkspaceMemberInvite) to unified "shadow user" pattern where invited users are real User records with a `status` field.

## Status: COMPLETED

All phases have been implemented.

## Clarified Requirements

From the preparation phase:

1. **Table cleanup**: Delete WorkspaceMemberInvite table after migration (clean approach)
2. **Status values**: Use only `invited`, `active`, `deactivated` (no separate `revoked` status - use `deactivated` for revoked invitations)
3. **Status default**: All existing users get `status='active'`

## Implementation Summary

### Phase 1: Add Status Fields to User Model - COMPLETED
- [x] Added `UserStatusChoices` enum with INVITED, ACTIVE, DEACTIVATED
- [x] Added `status` CharField with default='active'
- [x] Added `invited_at`, `activated_at` DateTimeFields
- [x] Added `invited_by` ForeignKey to User (self-referential)
- [x] Added `invitation_token` CharField (indexed)
- [x] Added `invitation_expires_at` DateTimeField
- [x] Added custom UserManager with `.active()`, `.invited()`, `.assignable()` methods
- [x] Created migration 0121_add_user_status_fields.py

### Phase 2: Update Invitation Creation Flow - COMPLETED
- [x] Modified WorkspaceInvitationsViewset.create() to create shadow users
- [x] Added `generate_unique_username()` helper (email prefix + UUID if collision)
- [x] Added `generate_invitation_token()` helper
- [x] Create WorkspaceMember immediately when inviting
- [x] Maintain backward compatibility with WorkspaceMemberInvite for email task

### Phase 3: Update Invitation Acceptance Flow - COMPLETED
- [x] Updated WorkspaceJoinEndpoint.post() to activate shadow user
- [x] Updated UserWorkspaceInvitationsViewSet.create() to activate shadow user
- [x] Clear invitation_token and set is_active=True on acceptance

### Phase 4: Update Frontend Components - COMPLETED
- [x] Added `TUserStatus` type to `packages/types/src/users.ts`
- [x] Added `status` field to `IUserLite` interface
- [x] Updated `member-options.tsx` to show "Pending" badge for invited users

### Phase 5: Migrate Existing Invitations - COMPLETED
- [x] Created data migration 0122_migrate_invitations_to_shadow_users.py
- [x] Converts pending WorkspaceMemberInvite records to shadow User records
- [x] Handles edge cases (existing active users, deactivated users)
- [x] Includes reverse migration

### Phase 6: Update API Serializers - COMPLETED
- [x] Added `status` field to UserLiteSerializer
- [x] Added `status` field to UserAdminLiteSerializer

### Phase 7: Handle Invitation Revocation - COMPLETED
- [x] Updated destroy() to check for assignments before allowing revocation
- [x] Returns error with list of assignments (project lead, issue assignee)
- [x] Deactivates shadow user and workspace membership if safe to revoke

### Phase 8: Update Seed Scripts - COMPLETED
- [x] Updated `_get_or_create_user()` to set status='active'
- [x] Added `_create_invited_users()` method for sample shadow users
- [x] Integrated into both demo and random seed methods

## Files Modified

**Backend:**
- `apps/api/plane/db/models/user.py` - Added UserStatusChoices, UserManager, and new fields
- `apps/api/plane/db/models/__init__.py` - Export UserStatusChoices
- `apps/api/plane/app/views/workspace/invite.py` - Rewrote invitation flow
- `apps/api/plane/app/serializers/user.py` - Added status field to serializers
- `apps/api/plane/db/management/commands/seed_data.py` - Added invited user seeding

**Frontend:**
- `packages/types/src/users.ts` - Added TUserStatus type and status field
- `apps/web/core/components/dropdowns/member/member-options.tsx` - Added Pending badge

**Migrations:**
- `apps/api/plane/db/migrations/0121_add_user_status_fields.py` - Schema changes
- `apps/api/plane/db/migrations/0122_migrate_invitations_to_shadow_users.py` - Data migration

## Testing Notes

To test the implementation:
1. Run migrations: `python manage.py migrate`
2. Seed data: `python manage.py seed_data --type=demo`
3. Invite a user to a workspace and verify shadow user is created
4. Check member dropdown shows "Pending" badge for invited users
5. Accept invitation and verify user status changes to active
6. Test revocation - verify it blocks if user has assignments

## Context

- Created: 2025-12-24
- Branch: shadow-user-invitations
- Base: master (b943458329)
- Purpose: Enable assigning pending/invited members to project leads, resources, etc.
