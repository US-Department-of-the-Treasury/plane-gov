# Claude Work Handoff - Phase 1 Complete

## Status: PHASE 1 COMPLETE

All tests passed. The Work Items page now loads correctly with:
- Layout picker responding to clicks
- Issues displayed in all layout modes (List, Kanban, Spreadsheet, Calendar, Gantt)
- Add Work Item modal opening without infinite loop errors

---

## Fixes Applied in This Session

### 1. Fix useIssueLoader infinite re-render (Previous Commit)

**Root Cause:** `useIssues()` internally calls `merge()` creating new object references on every render, breaking `useSyncExternalStore`.

**Fix:** Access zustand store directly from `StoreContext` instead of through `useIssues()`.

### 2. Fix useEditorAsset infinite re-render (This Session)

**File:** `apps/web/core/hooks/store/use-editor-asset.ts`

**Root Cause:** The `selectAssetsUploadPercentage` selector creates a **new object** on every call:
```typescript
// This creates a new object every time, even with same data
const assetsPercentage: Record<string, number> = {};
Object.keys(assetsStatus).forEach((blockId) => { ... });
return assetsPercentage;
```

This caused `useSyncExternalStore` to detect "changes" because object references differ, triggering infinite re-renders when opening the Add Work Item modal.

**Fix:** Added `useShallow` from zustand/react/shallow to perform shallow comparison:
```typescript
import { useShallow } from "zustand/react/shallow";

export const useEditorAsset = () => {
  const store = useEditorAssetStore();
  // Use useShallow to prevent infinite re-renders
  const assetsUploadPercentage = useEditorAssetStore(useShallow(selectAssetsUploadPercentage));
  return { ...store, assetsUploadPercentage };
};
```

### 3. Reactive hooks for proper re-renders

**File:** `apps/web/core/hooks/store/use-issue-store-reactive.ts`

Added reactive hooks that properly subscribe to Zustand stores:
- `useIssueLoader()` - Reactive issue loading status
- `useGroupedIssueCount()` - Reactive grouped issue count
- `useGroupedIssueIds()` - Reactive grouped issue IDs
- `useProjectIssueFilters()` - Reactive project filters

### 4. Sync TanStack Query data to Zustand

**File:** `apps/web/core/hooks/store/use-project-state.ts`

Modified `useProjectStates` to sync TanStack Query data to the Zustand state store. This ensures `getGroupByColumns()` has access to states during render.

### 5. Updated layout components

Updated all layout root components to use reactive hooks:
- `base-list-root.tsx`
- `base-kanban-root.tsx`
- `base-calendar-root.tsx`
- `base-gantt-root.tsx`
- `base-spreadsheet-root.tsx`
- `kanban/default.tsx`
- `kanban/swimlanes.tsx`
- `list/default.tsx`

---

## Files Changed

| File | Change |
|------|--------|
| `apps/web/core/hooks/store/use-editor-asset.ts` | Add useShallow to prevent infinite re-renders |
| `apps/web/core/hooks/store/use-issue-store-reactive.ts` | Add reactive hooks with useSyncExternalStore |
| `apps/web/core/hooks/store/use-project-state.ts` | Sync TanStack Query data to Zustand store |
| `apps/web/core/hooks/store/estimates/use-project-estimate.ts` | Handle undefined data in TanStack Query |
| `apps/web/core/store/issue/project/filter.store.ts` | Add getStoreState() for direct store access |
| `apps/web/core/components/issues/filters.tsx` | Use reactive hooks |
| `apps/web/core/components/issues/issue-layouts/roots/project-layout-root.tsx` | Use reactive filters |
| `apps/web/core/components/issues/issue-layouts/list/base-list-root.tsx` | Use reactive hooks |
| `apps/web/core/components/issues/issue-layouts/list/default.tsx` | Sync states for getGroupByColumns |
| `apps/web/core/components/issues/issue-layouts/kanban/base-kanban-root.tsx` | Use reactive hooks |
| `apps/web/core/components/issues/issue-layouts/kanban/default.tsx` | Minor cleanup |
| `apps/web/core/components/issues/issue-layouts/kanban/swimlanes.tsx` | Minor cleanup |
| `apps/web/core/components/issues/issue-layouts/calendar/base-calendar-root.tsx` | Use reactive hooks |
| `apps/web/core/components/issues/issue-layouts/gantt/base-gantt-root.tsx` | Use reactive hooks |
| `apps/web/core/components/issues/issue-layouts/spreadsheet/base-spreadsheet-root.tsx` | Use reactive hooks |

---

## Key Learnings

### Zustand + useSyncExternalStore Stability Requirements

When using `useSyncExternalStore` with Zustand selectors:

1. **Selectors must return stable references** - If a selector creates a new object/array, wrap with `useShallow()`
2. **Avoid passing through intermediate hooks** - Access the store directly from context when needed
3. **Test modal components** - They often reveal re-render issues due to their mounting behavior

### Pattern for Zustand Selector with Object Results

```typescript
// BAD - creates new object every render
const data = useStore(state => ({ a: state.a, b: state.b }));

// GOOD - shallow compare prevents re-renders
const data = useStore(useShallow(state => ({ a: state.a, b: state.b })));
```

---

## Environment

- **Branch:** mobx-tanstack-migration
- **Base:** master
- **Worktree:** /Users/corcoss/code/plane-gov/.worktrees/mobx-tanstack-migration
- **Dev Server:** http://localhost:3030

To start dev server:
```bash
pnpm dev:all
```

---

## Next Steps (Phase 2)

1. Continue migrating more MobX stores to TanStack Query + Zustand
2. Add more reactive hooks as needed
3. Monitor for additional infinite loop issues in other modals
