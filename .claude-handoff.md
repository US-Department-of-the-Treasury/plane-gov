# Claude Work Handoff

## Original Plan

See `plans/complete-mobx-to-tanstack-query-migration.md` for the full plan.

### Summary

MobX was removed as a dependency, but legacy patterns remain throughout the codebase. These patterns use zustand's `getState()` method (non-reactive snapshots) instead of proper subscriptions, causing reactivity bugs like skeleton loaders showing indefinitely.

**Migration Scope:**
| Category | Count | Location |
|----------|-------|----------|
| Files using deprecated `useIssues` hook | 54 | `@/hooks/store/use-issues` |
| Files with non-reactive `getState()` | 79 | `/core/store/` |
| Legacy store classes (`*Legacy`) | 26 | `/core/store/client/` |
| TanStack Query hooks (targets) | 31 | `/core/store/queries/` |

## Clarified Requirements

- **Verification approach:** Playwright E2E tests for visual validation
- **Scope:** All 5 phases (complete migration)
- **Playwright MCP:** Configured and available at `~/.claude.json`

## Visual Verification Plan

**Screenshots to capture for PR:**

| When | What to Capture | Why |
|------|-----------------|-----|
| **Before Phase 1** | Empty project showing infinite skeleton loader | Documents the current bug |
| **After Phase 1** | Empty project showing empty state (not skeleton) | Proves Phase 1 fixed the reactivity issue |
| **After Phase 1** | Project with issues showing correctly | Proves no regression for populated views |
| **After Phase 2** | Create issue -> immediate UI update | Proves TanStack Query mutations work |
| **After Phase 3** | Dev tools showing no legacy stores | Proves cleanup is complete |
| **Final** | Full E2E: empty -> create -> delete -> empty | Proves complete flow works |

## Initial Todo List

### Phase 1: Fix Critical UI Components (Priority: High)
- [ ] Capture "before" screenshot of infinite skeleton bug
- [ ] Migrate `issue-layout-HOC.tsx` to use TanStack Query
- [ ] Migrate `base-list-root.tsx` to use TanStack Query
- [ ] Migrate `base-kanban-root.tsx` to use TanStack Query
- [ ] Migrate `base-spreadsheet-root.tsx` to use TanStack Query
- [ ] Migrate `base-calendar-root.tsx` to use TanStack Query
- [ ] Migrate `base-gantt-root.tsx` to use TanStack Query
- [ ] Run Phase 1 Playwright validation tests
- [ ] Capture "after" screenshots for Phase 1

### Phase 2: Migrate Deprecated Hooks (Priority: Medium)
- [ ] Audit `/core/store/queries/` for missing hooks
- [ ] Create any missing query hooks
- [ ] Update imports in all 54 files using `useIssues`
- [ ] Refactor each component to use query hook pattern
- [ ] Handle mutations with `useMutation` hooks
- [ ] Run Phase 2 Playwright validation tests

### Phase 3: Remove Legacy Store Classes (Priority: Medium)
- [ ] Map all legacy store dependencies
- [ ] Migrate label store consumers to TanStack Query
- [ ] Delete label legacy store
- [ ] Repeat for each store type (state, priority, module, sprint, view, issue)
- [ ] Remove `EIssuesStoreType` enum
- [ ] Remove `useIssueStoreType()` hook
- [ ] Remove legacy store context providers
- [ ] Validate no `*Legacy*` files remain

### Phase 4: Fix Non-Reactive getState() Calls (Priority: Low)
- [ ] Grep all `getState()` calls in `/core/store/`
- [ ] Categorize each as valid/invalid
- [ ] Convert invalid usages to zustand selectors
- [ ] Update any that should use TanStack Query instead

### Phase 5: Cleanup and Documentation (Priority: Low)
- [ ] Delete `@/hooks/store/use-issues.ts`
- [ ] Delete other deprecated hook files
- [ ] Update CONTRIBUTING.md with state management guidelines
- [ ] Add ESLint rule to warn on deprecated imports

### Final Validation
- [ ] `pnpm check:types` passes
- [ ] `pnpm check:lint` passes
- [ ] `pnpm test:e2e` passes
- [ ] All visual verification screenshots captured
- [ ] No `*Legacy*` stores remain
- [ ] No deprecated imports remain

## Key Files to Migrate (Phase 1)

| File | Line | Current Pattern |
|------|------|-----------------|
| `apps/web/core/components/issues/issue-layouts/issue-layout-HOC.tsx` | 41-45 | `useIssues(storeType)` + `getIssueLoader()` |
| `apps/web/core/components/issues/issue-layouts/list/base-list-root.tsx` | TBD | `useIssues(storeType)` |
| `apps/web/core/components/issues/issue-layouts/kanban/base-kanban-root.tsx` | TBD | `useIssues(storeType)` |
| `apps/web/core/components/issues/issue-layouts/spreadsheet/base-spreadsheet-root.tsx` | TBD | `useIssues(storeType)` |
| `apps/web/core/components/issues/issue-layouts/calendar/base-calendar-root.tsx` | TBD | `useIssues(storeType)` |
| `apps/web/core/components/issues/issue-layouts/gantt/base-gantt-root.tsx` | TBD | `useIssues(storeType)` |

## Migration Pattern

```typescript
// BEFORE (non-reactive)
const { issues } = useIssues(storeType);
const loader = issues?.getIssueLoader();
const issueCount = issues.getGroupIssueCount(undefined, undefined, false);

// AFTER (reactive with TanStack Query)
const { data: issues, isLoading, isFetching } = useIssuesQuery({ projectId, filters });
const issueCount = issues?.length ?? 0;
```

## E2E Test Fixes (2025-12-25)

Fixed E2E authentication issues that were blocking test execution:

1. **Password selector issue** - `getByLabel(/password/i)` matched both "Password" and "Confirm Password" fields. Fixed by using `#password` ID selector.

2. **E2E_BASE_URL not passed to globalSetup** - The environment variable wasn't being read. Fixed by reading from `process.env.E2E_BASE_URL`.

3. **Missing VITE_API_BASE_URL** - Frontend wasn't getting the API URL. Fixed by creating `.env` file in `test-e2e.sh` with dynamic ports.

4. **Wrong redirect URL after login** - API was redirecting to hardcoded `localhost:3000` instead of dynamic port. Fixed by adding `WEB_URL` and `APP_BASE_URL` exports in `test-e2e.sh`.

**Files modified:**
- `apps/web/e2e/fixtures/auth.ts` - Password selector fix
- `scripts/test-e2e.sh` - Added redirect URL overrides and .env creation

**Test results:**
- Smoke tests: 87 passed, 2 skipped
- CRUD tests: 30 passed, 3 skipped, 1 failed (sprint completion - unrelated to auth)

## Context

- **Created:** 2025-12-24
- **Branch:** mobx-tanstack-migration
- **Base:** master
- **Worktree Path:** /Users/corcoss/code/plane-gov/.worktrees/mobx-tanstack-migration
