# Claude Work Handoff - Phase 2 In Progress

## Status: PHASE 2 IN PROGRESS ✅

### Sprint Layout Switching Fix (Completed)

Fixed reactivity bug where Sprint layout buttons would update but content wouldn't switch.

**Root Cause:** Mismatch between header (MobX wrapper reading Zustand) and `SprintLayoutRoot` (direct Zustand hook) sources for layout state.

**Fix Applied:**
1. Changed `SprintLayoutRoot` to use `issuesFilter?.issueFilters?.displayFilters?.layout` (same source as header)
2. Updated `sprint/filter.store.ts` to use `setDisplayFilters` directly instead of `updateFilterField` with `lodashSet`

**Verified Working:** All Sprint layout transitions (List ↔ Kanban ↔ Calendar ↔ Gantt ↔ Spreadsheet)

### Filter Store Fixes for Zustand Reactivity (Completed)

Fixed same `updateFilterField` bug in other filter stores that used array path notation with `lodashSet`.

**Bug Pattern:** Using `lodashSet(state.filters, [viewId, field], value)` where `field` is a dot-notation string like `"displayFilters.layout"` doesn't work - it creates a literal key `"displayFilters.layout"` instead of nested path.

**Stores Fixed:**
1. **Project View filter store** (`project-views/filter.store.ts`)
   - Added dedicated setter methods (`setDisplayFilters`, `setDisplayProperties`, etc.)
   - Updated `updateFilters` to use setters directly
   - Fixed `updateFilterField` to use string path: `lodashSet(state.filters, \`${viewId}.${field}\`, value)`

2. **Workspace filter store** (`workspace/filter.store.ts`)
   - Same fix pattern as Project View
   - Added dedicated setter methods
   - Updated all `updateFilters` cases to use setters

**Stores Already Correct:**
- **Profile filter store** - Already used dedicated setter methods
- **Archived filter store** - Uses correct 3-element array paths like `[projectId, "displayFilters", _key]`
- **Epic filter store** - Already used `setDisplayFilters` directly
- **Team View filter store** - Extends ProjectViewIssuesFilter, inherits fix

---

## Phase 1 Status: COMPLETE ✅

All tests passed. Comprehensive testing verified:

### Core Functionality
- Layout picker responding to clicks
- Issues displayed in all layout modes (List, Kanban, Spreadsheet, Calendar, Gantt)
- Add Work Item modal opening without infinite loop errors
- Work items can be created and saved successfully

### Pages Tested (All Passing)
| Page | Status | Notes |
|------|--------|-------|
| Login/Auth | ✅ | Authentication working |
| Home | ✅ | Quickstart, quicklinks, recents all loading |
| Projects list | ✅ | Projects display correctly |
| Work Items | ✅ | All 5 layouts working (List, Kanban, Calendar, Gantt, Spreadsheet) |
| Work Item creation | ✅ | Modal opens, saves, item appears after refresh |
| Sprints | ✅ | Shows Active, Upcoming, Completed sections |
| Epics | ✅ | Page loads (empty content expected) |
| Views | ✅ | Project views page with filters |
| Pages/Wiki | ✅ | Public/Private/Archived tabs |
| Settings - Workspace | ✅ | General settings form |
| Settings - Account | ✅ | Profile editing |
| Settings - Projects | ✅ | Project configuration |
| Drafts | ✅ | Draft work items page |
| Analytics | ✅ | Overview and Work items tabs |
| Archives | ✅ | Archived projects list |

### Sidebar Navigation
All sidebar links working:
- Home, Drafts, Your work
- Workspace: Projects, Views, Analytics, Archives
- Project: Work items, Sprints, Epics, Views, Pages, Intake

---

## Fixes Applied in This Session

### 1. Fix useIssueLoader infinite re-render (Previous Commit)

**Root Cause:** `useIssues()` internally calls `merge()` creating new object references on every render, breaking `useSyncExternalStore`.

**Fix:** Access zustand store directly from `StoreContext` instead of through `useIssues()`.

### 2. Fix useEditorAsset infinite re-render (This Session)

**File:** `apps/web/core/hooks/store/use-editor-asset.ts`

**Root Cause:** The `selectAssetsUploadPercentage` selector creates a **new object** on every call:
```typescript
// This creates a new object every time, even with same data
const assetsPercentage: Record<string, number> = {};
Object.keys(assetsStatus).forEach((blockId) => { ... });
return assetsPercentage;
```

This caused `useSyncExternalStore` to detect "changes" because object references differ, triggering infinite re-renders when opening the Add Work Item modal.

**Fix:** Added `useShallow` from zustand/react/shallow to perform shallow comparison:
```typescript
import { useShallow } from "zustand/react/shallow";

export const useEditorAsset = () => {
  const store = useEditorAssetStore();
  // Use useShallow to prevent infinite re-renders
  const assetsUploadPercentage = useEditorAssetStore(useShallow(selectAssetsUploadPercentage));
  return { ...store, assetsUploadPercentage };
};
```

### 3. Reactive hooks for proper re-renders

**File:** `apps/web/core/hooks/store/use-issue-store-reactive.ts`

Added reactive hooks that properly subscribe to Zustand stores:
- `useIssueLoader()` - Reactive issue loading status
- `useGroupedIssueCount()` - Reactive grouped issue count
- `useGroupedIssueIds()` - Reactive grouped issue IDs
- `useProjectIssueFilters()` - Reactive project filters

### 4. Sync TanStack Query data to Zustand

**File:** `apps/web/core/hooks/store/use-project-state.ts`

Modified `useProjectStates` to sync TanStack Query data to the Zustand state store. This ensures `getGroupByColumns()` has access to states during render.

### 5. Fix Zustand updateFilterField lodash path bug

**File:** `apps/web/core/store/issue/project/filter.store.ts`

**Root Cause:** The `updateFilterField` action was using `lodashSet` with array path notation:
```typescript
// BUG: With array path, lodash treats "displayFilters.layout" as a literal key
lodashSet(state.filters, [projectId, field], value);
// Result: state.filters[projectId]["displayFilters.layout"] = "kanban"
// Instead of: state.filters[projectId].displayFilters.layout = "kanban"
```

This caused layout switches to create a new property with a literal dot-containing key instead of updating the nested `displayFilters.layout` property. The API was called with the old layout parameter because `getFilterParams` read from the unchanged nested property.

**Fix:** Use string path notation so lodash properly parses nested keys:
```typescript
// FIXED: String path parses dots correctly
lodashSet(state.filters, `${projectId}.${field}`, value);
```

### 6. Updated layout components

Updated all layout root components to use reactive hooks:
- `base-list-root.tsx`
- `base-kanban-root.tsx`
- `base-calendar-root.tsx`
- `base-gantt-root.tsx`
- `base-spreadsheet-root.tsx`
- `kanban/default.tsx`
- `kanban/swimlanes.tsx`
- `list/default.tsx`

---

## Files Changed

| File | Change |
|------|--------|
| `apps/web/core/hooks/store/use-editor-asset.ts` | Add useShallow to prevent infinite re-renders |
| `apps/web/core/hooks/store/use-issue-store-reactive.ts` | Add reactive hooks with useSyncExternalStore |
| `apps/web/core/hooks/store/use-project-state.ts` | Sync TanStack Query data to Zustand store |
| `apps/web/core/hooks/store/estimates/use-project-estimate.ts` | Handle undefined data in TanStack Query |
| `apps/web/core/store/issue/project/filter.store.ts` | Add getStoreState() for direct store access |
| `apps/web/core/components/issues/filters.tsx` | Use reactive hooks |
| `apps/web/core/components/issues/issue-layouts/roots/project-layout-root.tsx` | Use reactive filters |
| `apps/web/core/components/issues/issue-layouts/list/base-list-root.tsx` | Use reactive hooks |
| `apps/web/core/components/issues/issue-layouts/list/default.tsx` | Sync states for getGroupByColumns |
| `apps/web/core/components/issues/issue-layouts/kanban/base-kanban-root.tsx` | Use reactive hooks |
| `apps/web/core/components/issues/issue-layouts/kanban/default.tsx` | Minor cleanup |
| `apps/web/core/components/issues/issue-layouts/kanban/swimlanes.tsx` | Minor cleanup |
| `apps/web/core/components/issues/issue-layouts/calendar/base-calendar-root.tsx` | Use reactive hooks |
| `apps/web/core/components/issues/issue-layouts/gantt/base-gantt-root.tsx` | Use reactive hooks |
| `apps/web/core/components/issues/issue-layouts/spreadsheet/base-spreadsheet-root.tsx` | Use reactive hooks |
| `apps/web/core/store/issue/sprint/filter.store.ts` | Use setDisplayFilters directly for proper Zustand reactivity |
| `apps/web/core/components/issues/issue-layouts/roots/sprint-layout-root.tsx` | Use MobX wrapper getter for layout instead of Zustand hook |
| `apps/web/core/store/issue/project-views/filter.store.ts` | Add setter methods, use setDisplayFilters instead of updateFilterField |
| `apps/web/core/store/issue/workspace/filter.store.ts` | Add setter methods, use setDisplayFilters instead of updateFilterField |

---

## Key Learnings

### lodashSet Array vs String Path Notation with Immer

When using `lodashSet` inside Zustand's immer middleware:

```typescript
// BUG: Array notation with dot-containing string creates literal key
lodashSet(state.filters, [viewId, "displayFilters.layout"], value);
// Result: state.filters[viewId]["displayFilters.layout"] = value (literal key!)

// FIXED: String path notation parses dots correctly
lodashSet(state.filters, `${viewId}.displayFilters.layout`, value);
// Result: state.filters[viewId].displayFilters.layout = value (nested path!)

// BEST: Use dedicated setter methods for complex objects
setDisplayFilters(viewId, { layout: value });
// Creates proper new object references for Zustand selectors to detect
```

### Zustand + useSyncExternalStore Stability Requirements

When using `useSyncExternalStore` with Zustand selectors:

1. **Selectors must return stable references** - If a selector creates a new object/array, wrap with `useShallow()`
2. **Avoid passing through intermediate hooks** - Access the store directly from context when needed
3. **Test modal components** - They often reveal re-render issues due to their mounting behavior

### Pattern for Zustand Selector with Object Results

```typescript
// BAD - creates new object every render
const data = useStore(state => ({ a: state.a, b: state.b }));

// GOOD - shallow compare prevents re-renders
const data = useStore(useShallow(state => ({ a: state.a, b: state.b })));
```

---

## Environment

- **Branch:** mobx-tanstack-migration
- **Base:** master
- **Worktree:** /Users/corcoss/code/plane-gov/.worktrees/mobx-tanstack-migration
- **Dev Server:** http://localhost:3030

To start dev server:
```bash
pnpm dev:all
```

---

## Next Steps (Phase 2)

1. Continue migrating more MobX stores to TanStack Query + Zustand
2. Add more reactive hooks as needed
3. Monitor for additional infinite loop issues in other modals
