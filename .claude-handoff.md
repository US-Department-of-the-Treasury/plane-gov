# Claude Work Handoff

## Original Plan

See `/Users/corcoss/code/plane/plans/shadow-user-invitation-pattern.md` for the full plan.

**Summary:** Convert invitation system from two-table pattern (User + WorkspaceMemberInvite) to unified "shadow user" pattern where invited users are real User records with a `status` field.

## Status: COMPLETED

All phases have been implemented.

## Clarified Requirements

From the preparation phase:

1. **Table cleanup**: Delete WorkspaceMemberInvite table after migration (clean approach)
2. **Status values**: Use only `invited`, `active`, `deactivated` (no separate `revoked` status - use `deactivated` for revoked invitations)
3. **Status default**: All existing users get `status='active'`

## Implementation Summary

### Phase 1: Add Status Fields to User Model - COMPLETED

- [x] Added `UserStatusChoices` enum with INVITED, ACTIVE, DEACTIVATED
- [x] Added `status` CharField with default='active'
- [x] Added `invited_at`, `activated_at` DateTimeFields
- [x] Added `invited_by` ForeignKey to User (self-referential)
- [x] Added `invitation_token` CharField (indexed)
- [x] Added `invitation_expires_at` DateTimeField
- [x] Added custom UserManager with `.active()`, `.invited()`, `.assignable()` methods
- [x] Created migration 0121_add_user_status_fields.py

### Phase 2: Update Invitation Creation Flow - COMPLETED

- [x] Modified WorkspaceInvitationsViewset.create() to create shadow users
- [x] Added `generate_unique_username()` helper (email prefix + UUID if collision)
- [x] Added `generate_invitation_token()` helper
- [x] Create WorkspaceMember immediately when inviting
- [x] Maintain backward compatibility with WorkspaceMemberInvite for email task

### Phase 3: Update Invitation Acceptance Flow - COMPLETED

- [x] Updated WorkspaceJoinEndpoint.post() to activate shadow user
- [x] Updated UserWorkspaceInvitationsViewSet.create() to activate shadow user
- [x] Clear invitation_token and set is_active=True on acceptance

### Phase 4: Update Frontend Components - COMPLETED

- [x] Added `TUserStatus` type to `packages/types/src/users.ts`
- [x] Added `status` field to `IUserLite` interface
- [x] Updated `member-options.tsx` to show "Pending" badge for invited users

### Phase 5: Migrate Existing Invitations - COMPLETED

- [x] Created data migration 0122_migrate_invitations_to_shadow_users.py
- [x] Converts pending WorkspaceMemberInvite records to shadow User records
- [x] Handles edge cases (existing active users, deactivated users)
- [x] Includes reverse migration

### Phase 6: Update API Serializers - COMPLETED

- [x] Added `status` field to UserLiteSerializer
- [x] Added `status` field to UserAdminLiteSerializer

### Phase 7: Handle Invitation Revocation - COMPLETED

- [x] Updated destroy() to check for assignments before allowing revocation
- [x] Returns error with list of assignments (project lead, issue assignee)
- [x] Deactivates shadow user and workspace membership if safe to revoke

### Phase 8: Update Seed Scripts - COMPLETED

- [x] Updated `_get_or_create_user()` to set status='active'
- [x] Added `_create_invited_users()` method for sample shadow users
- [x] Integrated into both demo and random seed methods

## Files Modified

**Backend:**

- `apps/api/plane/db/models/user.py` - Added UserStatusChoices, UserManager, and new fields
- `apps/api/plane/db/models/__init__.py` - Export UserStatusChoices
- `apps/api/plane/app/views/workspace/invite.py` - Rewrote invitation flow
- `apps/api/plane/app/serializers/user.py` - Added status field to serializers
- `apps/api/plane/db/management/commands/seed_data.py` - Added invited user seeding

**Frontend:**

- `packages/types/src/users.ts` - Added TUserStatus type and status field
- `apps/web/core/components/dropdowns/member/member-options.tsx` - Added Pending badge

**Migrations:**

- `apps/api/plane/db/migrations/0121_add_user_status_fields.py` - Schema changes
- `apps/api/plane/db/migrations/0122_migrate_invitations_to_shadow_users.py` - Data migration

## Post-Implementation Bug Fixes (Session 2)

During code review, three additional bugs were found and fixed:

### Bug 1: Shadow users not activated on OAuth/PIV login

- **File:** `apps/api/plane/authentication/adapter/base.py`
- **Issue:** `save_user_data()` set `is_active=True` but didn't update `status` from 'invited' to 'active'
- **Fix:** Added status update logic to activate invited users on first login
- **Commit:** "fix(auth): activate shadow users on OAuth/PIV login"

### Bug 2: Shadow users missing Profile record

- **Files:** `invite.py`, `0122_migration.py`, `seed_data.py`
- **Issue:** `WorkspaceJoinEndpoint.post()` accesses `user.profile` which would crash if Profile doesn't exist
- **Fix:** Added Profile creation when creating shadow users in all three locations
- **Commit:** "fix(invite): create Profile for shadow users"

### Bug 3: Legacy users might not have Profile

- **File:** `apps/api/plane/app/views/workspace/invite.py`
- **Issue:** Invitation acceptance assumes user has Profile, but legacy users might not
- **Fix:** Changed `user.profile` access to `Profile.objects.get_or_create(user=user)`
- **Commit:** "fix(invite): use get_or_create for Profile in acceptance flow"

## Testing Notes

To test the implementation:

1. Run migrations: `python manage.py migrate`
2. Seed data: `python manage.py seed_data --type=demo`
3. Invite a user to a workspace and verify shadow user is created
4. Check member dropdown shows "Pending" badge for invited users
5. Accept invitation and verify user status changes to active
6. Test revocation - verify it blocks if user has assignments

## Code Review Verification

The following flows were verified during code review:

1. **Email invitation flow:** Invitation email is sent with correct link → User clicks link → Frontend fetches invite details → User accepts → Backend activates shadow user → Profile.last_workspace_id is set
2. **OAuth/PIV login flow:** Shadow user authenticates → `save_user_data()` activates the user and clears invitation token
3. **Password login for shadow users:** Correctly fails with "AUTHENTICATION_FAILED_SIGN_IN" (shadow users have no password)
4. **Profile access safety:** All authenticated-only endpoints that access Profile are protected; shadow users can't authenticate

## Post-Implementation Bug Fixes (Session 3)

### Bug 4: Invited users not appearing in Lead dropdown after invitation

- **File:** `apps/web/core/store/queries/member.ts`
- **Issue:** After inviting a user, the workspace members query was not invalidated, so the Lead dropdown showed stale data
- **Root Cause:** `useInviteWorkspaceMembers` only invalidated the invitations query (`["members", "workspace", slug, "invitations"]`) but NOT the workspace members query (`["members", "workspace", slug]`). Since shadow users are now real `WorkspaceMember` records, the members query needs to be refreshed.
- **Fix:** Updated three mutation hooks to invalidate both workspace members AND invitations queries:
  - `useInviteWorkspaceMembers` - now invalidates workspace members query
  - `useUpdateWorkspaceInvitation` - now invalidates workspace members query (role changes sync)
  - `useDeleteWorkspaceInvitation` - now invalidates workspace members query (deletion deactivates shadow user)

### Bug 5: Pending invites briefly showing then disappearing

- **Related to Bug 4** - Same root cause. The invitations were showing in one component but the members list (which also includes invited users) wasn't being refreshed.
- **Fix:** Same as Bug 4 - proper query invalidation ensures data consistency across all components.

### Bug 6: Display name inferred from email prefix instead of using full email

- **File:** `apps/api/plane/app/views/workspace/invite.py`
- **Issue:** Shadow users had their display_name auto-set to the email prefix (e.g., "bob" from "bob@treasury.gov") instead of the full email
- **Root Cause:** User model's `save()` method defaults `display_name` to `email.split("@")[0]` when not provided
- **Fix:** Explicitly set `display_name=email` when creating shadow users

### UI Cleanup: Removed redundant "Pending invites" section

- **File:** `apps/web/core/components/workspace/settings/members-list.tsx`
- **Issue:** With shadow user pattern, invited users already appear in the main members list, making "Pending invites" section redundant
- **Fix:** Removed the Collapsible "Pending invites" section entirely

### UI Enhancement: Added "Pending" badge to members list

- **File:** `apps/web/core/components/workspace/settings/member-columns.tsx`
- **Change:** Added inline amber "Pending" pill badge next to invited users in the members table
- **Also:** Fixed name display to fall back to email when first_name/last_name are empty

## Context

- Created: 2025-12-24
- Branch: shadow-user-invitations
- Base: master (b943458329)
- Purpose: Enable assigning pending/invited members to project leads, resources, etc.
